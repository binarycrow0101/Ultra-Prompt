<script>
const themes = ["Fantasy", "Sci-Fi", "Spooky", "Silly", "Superhero", "Mashup"];
let currentThemeIndex = -1;

// Word banks (trimmed for clarity)
const banks = {
  Fantasy: {
    roles: ["Wizard", "Knight", "Fairy", "Goblin"],
    subjects: ["dragon egg", "enchanted sword", "ancient ruin"],
    actions: ["guards", "steals", "awakens"],
    contexts: ["under a blood moon", "in the misty woods", "at dawn"]
  },
  SciFi: {
    roles: ["Android", "Pilot", "Scientist", "Alien"],
    subjects: ["warp drive", "nanobot swarm", "quantum rift"],
    actions: ["tests", "sabotages", "discovers"],
    contexts: ["inside a derelict station", "during hyperspace", "on Mars"]
  },
  Spooky: {
    roles: ["Ghost", "Gravedigger", "Witch", "Doll"],
    subjects: ["mirror", "lantern", "tomb", "curse"],
    actions: ["haunts", "screams at", "possesses"],
    contexts: ["in a thunderstorm", "at midnight", "beneath the church"]
  }
};

const dial = document.getElementById("dial");
const phraseEl = document.getElementById("phrase");
const themeName = document.getElementById("themeName");

let isDragging = false;
let currentAngle = 0;

dial.addEventListener("mousedown", startDrag);
window.addEventListener("mouseup", stopDrag);
window.addEventListener("mousemove", rotateDial);
dial.addEventListener("touchstart", e => startDrag(e.touches[0]));
window.addEventListener("touchmove", e => rotateDial(e.touches[0]));
window.addEventListener("touchend", stopDrag);

function startDrag(e) { isDragging = true; updateAngle(e); }
function stopDrag() { isDragging = false; }

function rotateDial(e) {
  if (!isDragging) return;
  updateAngle(e);
}

function updateAngle(e) {
  const rect = dial.getBoundingClientRect();
  const cx = rect.left + rect.width / 2;
  const cy = rect.top + rect.height / 2;
  const dx = e.clientX - cx;
  const dy = e.clientY - cy;
  const angle = Math.atan2(dy, dx) * (180 / Math.PI);
  currentAngle = (angle + 450) % 360; // normalize
  dial.style.transform = `rotate(${currentAngle}deg)`;

  const index = Math.floor(currentAngle / (360 / themes.length));
  if (index !== currentThemeIndex) {
    currentThemeIndex = index;
    const t = themes[currentThemeIndex];
    themeName.textContent = t;
    generatePhrase(t);
    dial.classList.add("snap");
    setTimeout(()=>dial.classList.remove("snap"),150);
  }
}

// — Phrase assembly effect —
function generatePhrase(theme) {
  const bank = banks[theme];
  if (!bank) return;
  const phrase = `${rand(bank.roles)} ${rand(bank.subjects)} ${rand(bank.actions)} ${rand(bank.contexts)}`;
  glitchText(phrase);
}

function rand(arr){return arr[Math.floor(Math.random()*arr.length)]}

function glitchText(fullText) {
  const chars = "!@#$%^&*()_+=-?<>~◊░▒▓█";
  let display = Array(fullText.length).fill(" ");
  phraseEl.textContent = "";
  let progress = 0;
  const interval = setInterval(()=>{
    for (let i=0; i<fullText.length; i++) {
      if (Math.random() < progress / fullText.length) display[i] = fullText[i];
      else display[i] = chars[Math.floor(Math.random() * chars.length)];
    }
    phraseEl.textContent = display.join("");
    progress++;
    if (progress > fullText.length + 5) clearInterval(interval);
  }, 40);
}
</script>
